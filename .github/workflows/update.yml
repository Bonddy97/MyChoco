name: Update & Push

on:
  schedule:
    - cron: '0 0 * * *'  # 每天午夜运行
  workflow_dispatch:
  push:

jobs:
  Directories:
    name: Get directories
    runs-on: ubuntu-latest

    permissions:
      # 将默认的 GITHUB_TOKEN 赋予对仓库进行提交和推送的写权限。
      contents: write

    outputs:
      folders: ${{ steps.directories.outputs.folders }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - run: sudo apt update && sudo apt install tree jq -y
      shell: bash

    - name: Get directories
      id: directories
      run: |
        cd ./Packages
        folders=$(tree -J -d -L 1 | jq -c '.[0].contents | map(.name)')
        echo $folders
        echo "folders=$folders" >> $GITHUB_OUTPUT

  Pack-Push:
    name: "Pack & Push"
    needs: [Directories]
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        folder: ${{ fromJson(needs.Directories.outputs.folders )}}
    defaults:
      run:
        working-directory: "Packages/${{ matrix.folder }}"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update repository
        run: |
          git pull

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
  
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run script
        run: python update.py

      # Commit all changed files back to the repository
      - name: Push to branch
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # 可选。用于创建提交的提交信息。
          # 默认为"Apply automatic changes"。
          commit_message: Update ${{ matrix.folder }}